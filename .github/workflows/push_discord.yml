name: discord message
on:
  push:
    branches:
      - main
  # release:
  #   types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Discord message
        id: prepare_message
        run: |
          # æ„é€ å®Œæ•´æ¶ˆæ¯
          full_msg="ğŸš€ **New Release!** ${{ github.event.release.name }}

          **Tag:** ${{ github.event.release.tag_name }}
          **Author:** ${{ github.event.release.author.login }}

          **Release Notes:**
          ${{ github.event.release.body }}"

              # æˆªæ–­åˆ° 1990 å­—ç¬¦ï¼ˆç•™ 10 å­—ç¬¦ç»™å¯èƒ½çš„ ... å’Œå®‰å…¨ä½™é‡ï¼‰
              if [ ${#full_msg} -gt 1990 ]; then
                truncated_msg="${full_msg:0:1987}..."
              else
                truncated_msg="$full_msg"
              fi

              # è½¬ä¹‰æ¢è¡Œç¬¦å’Œç‰¹æ®Šå­—ç¬¦ï¼Œä»¥ä¾¿é€šè¿‡ env ä¼ é€’ï¼ˆå¯é€‰ï¼Œä½†æ›´å®‰å…¨ï¼‰
              echo "DISCORD_MSG<<EOF" >> $GITHUB_ENV
              echo "$truncated_msg" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_USERNAME: Github Actions
          DISCORD_AVATAR: https://cdn.discordapp.com/avatars/1460099944252702846/e57fd67dc7ca0cc840a0e87a82281bc5.webp?size=80
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: |
            ${{ env.DISCORD_MSG }}
